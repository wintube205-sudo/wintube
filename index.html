<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WinTube</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&family=Bebas+Neue&display=swap" rel="stylesheet">
<style>
:root{--red:#ff2d2d;--dark:#0a0a0a;--card:#111;--border:#1e1e1e;--text:#f0f0f0;--muted:#666;--green:#22c55e;--yellow:#f59e0b;}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--dark);color:var(--text);font-family:'Cairo',sans-serif;min-height:100vh;overflow-x:hidden;}
header{position:sticky;top:0;z-index:100;background:rgba(10,10,10,.97);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);padding:0 2rem;height:70px;display:flex;align-items:center;gap:1.5rem;}
.logo{font-family:'Bebas Neue',sans-serif;font-size:2rem;color:var(--red);letter-spacing:3px;white-space:nowrap;text-shadow:0 0 30px rgba(255,45,45,.5);flex-shrink:0;}
.logo span{color:var(--text);}
.search-bar{flex:1;display:flex;max-width:550px;}
.search-bar input{flex:1;background:var(--card);border:1px solid var(--border);border-left:none;color:var(--text);padding:.65rem 1.2rem;font-family:'Cairo',sans-serif;font-size:.9rem;outline:none;transition:border-color .2s;border-radius:0 8px 8px 0;}
.search-bar input:focus{border-color:var(--red);}
.search-bar button{background:var(--red);border:none;color:#fff;padding:0 1.3rem;cursor:pointer;font-size:1rem;border-radius:8px 0 0 8px;}
.user-panel{margin-right:auto;display:flex;align-items:center;gap:.8rem;background:var(--card);border:1px solid var(--border);border-radius:50px;padding:.4rem 1rem;cursor:pointer;flex-shrink:0;}
.user-panel:hover{border-color:var(--red);}
.user-avatar{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,var(--red),#ff8c00);display:flex;align-items:center;justify-content:center;font-size:.9rem;font-weight:700;color:#fff;}
.user-name{font-size:.8rem;font-weight:600;}
.user-pts{font-size:.75rem;color:var(--yellow);}
.categories{padding:.8rem 2rem;display:flex;gap:.6rem;overflow-x:auto;border-bottom:1px solid var(--border);scrollbar-width:none;}
.categories::-webkit-scrollbar{display:none;}
.cat-btn{background:var(--card);border:1px solid var(--border);color:var(--muted);padding:.4rem 1.1rem;border-radius:50px;cursor:pointer;font-family:'Cairo',sans-serif;font-size:.82rem;white-space:nowrap;transition:all .2s;}
.cat-btn:hover,.cat-btn.active{background:var(--red);border-color:var(--red);color:#fff;}
main{padding:2rem;}
.section-title{font-size:1.2rem;font-weight:700;margin-bottom:1.5rem;display:flex;align-items:center;gap:.8rem;}
.section-title::before{content:'';width:4px;height:1.3em;background:var(--red);border-radius:2px;display:inline-block;}
.video-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(290px,1fr));gap:1.5rem;}
.video-card{background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden;cursor:pointer;transition:transform .25s,border-color .25s,box-shadow .25s;}
.video-card:hover{transform:translateY(-4px);border-color:var(--red);box-shadow:0 8px 30px rgba(255,45,45,.15);}
.thumb-wrap{position:relative;aspect-ratio:16/9;overflow:hidden;}
.thumb-wrap img{width:100%;height:100%;object-fit:cover;transition:transform .4s;}
.video-card:hover .thumb-wrap img{transform:scale(1.05);}
.play-overlay{position:absolute;inset:0;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .25s;}
.video-card:hover .play-overlay{opacity:1;}
.play-btn{width:54px;height:54px;background:var(--red);border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 20px rgba(255,45,45,.6);}
.play-btn svg{fill:#fff;margin-right:-2px;}
.duration{position:absolute;bottom:8px;left:8px;background:rgba(0,0,0,.85);color:#fff;font-size:.72rem;padding:2px 6px;border-radius:4px;}
.card-info{padding:.9rem;}
.card-title{font-size:.9rem;font-weight:600;line-height:1.4;margin-bottom:.5rem;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
.card-meta{font-size:.78rem;color:var(--muted);display:flex;justify-content:space-between;}
.channel-name{color:#aaa;font-weight:600;}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.92);z-index:1000;display:flex;align-items:center;justify-content:center;padding:1rem;opacity:0;pointer-events:none;transition:opacity .3s;}
.modal-overlay.open{opacity:1;pointer-events:all;}
.modal{background:var(--card);border:1px solid var(--border);border-radius:16px;width:100%;max-width:900px;overflow:hidden;transform:scale(.95);transition:transform .3s;}
.modal-overlay.open .modal{transform:scale(1);}
.modal-header{display:flex;align-items:center;gap:1rem;padding:.9rem 1.3rem;border-bottom:1px solid var(--border);}
.close-btn{background:#222;border:none;color:#fff;width:34px;height:34px;border-radius:50%;cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.close-btn:hover{background:var(--red);}
.modal-title{font-size:.9rem;font-weight:600;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.iframe-wrap{aspect-ratio:16/9;background:#000;}
.iframe-wrap iframe{width:100%;height:100%;border:none;}
.modal-desc{padding:1rem 1.3rem;max-height:100px;overflow-y:auto;font-size:.83rem;line-height:1.7;color:#999;}
.points-counter{display:flex;align-items:center;gap:.7rem;background:rgba(0,0,0,.5);border:1px solid #2a2a2a;border-radius:50px;padding:.35rem .9rem .35rem .7rem;flex-shrink:0;}
.timer-ring{position:relative;width:38px;height:38px;flex-shrink:0;}
.timer-ring svg{transform:rotate(-90deg);}
.ring-bg{fill:none;stroke:#2a2a2a;stroke-width:3;}
.ring-fill{fill:none;stroke-width:3;stroke-linecap:round;stroke-dasharray:101;stroke-dashoffset:0;transition:stroke-dashoffset 1s linear,stroke .4s;}
.timer-num{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:.65rem;font-weight:800;}
.pts-info{text-align:right;}
.pts-label{font-size:.68rem;color:var(--muted);}
.pts-val{font-size:1.05rem;font-weight:800;color:var(--yellow);}
.pts-val.flash{animation:ptsBlink .5s ease;color:var(--red)!important;}
@keyframes ptsBlink{0%,100%{transform:scale(1)}50%{transform:scale(1.35)}}
.toast{position:fixed;top:80px;left:50%;transform:translateX(-50%) translateY(-10px);background:rgba(255,45,45,.92);color:#fff;padding:.55rem 1.4rem;border-radius:50px;font-size:.9rem;font-weight:700;z-index:9999;opacity:0;pointer-events:none;transition:opacity .3s,transform .3s;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
.auth-overlay{position:fixed;inset:0;background:rgba(0,0,0,.96);z-index:2000;display:flex;align-items:center;justify-content:center;padding:1rem;}
.auth-overlay.hidden{display:none;}
.auth-box{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:2.5rem;width:100%;max-width:380px;text-align:center;}
.auth-logo{font-family:'Bebas Neue',sans-serif;font-size:2.5rem;color:var(--red);letter-spacing:4px;text-shadow:0 0 30px rgba(255,45,45,.5);}
.auth-logo span{color:var(--text);}
.auth-sub{color:var(--muted);font-size:.88rem;margin:.3rem 0 1.5rem;}
.bonus-badge{background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.3);border-radius:8px;padding:.55rem;font-size:.82rem;color:var(--green);margin-bottom:1.2rem;}
.auth-tabs{display:flex;background:#0a0a0a;border-radius:10px;padding:4px;margin-bottom:1.5rem;gap:4px;}
.auth-tab{flex:1;padding:.5rem;border:none;background:transparent;color:var(--muted);font-family:'Cairo',sans-serif;font-size:.88rem;cursor:pointer;border-radius:8px;transition:all .2s;}
.auth-tab.active{background:var(--red);color:#fff;font-weight:600;}
.auth-input{width:100%;background:#0a0a0a;border:1px solid var(--border);color:var(--text);padding:.75rem 1rem;font-family:'Cairo',sans-serif;font-size:.9rem;border-radius:10px;outline:none;margin-bottom:.75rem;text-align:right;transition:border-color .2s;display:block;}
.auth-input:focus{border-color:var(--red);}
.auth-submit{width:100%;background:var(--red);border:none;color:#fff;padding:.85rem;border-radius:10px;font-family:'Cairo',sans-serif;font-size:1rem;font-weight:700;cursor:pointer;margin-top:.2rem;}
.auth-submit:hover{background:#cc2424;}
.auth-submit:disabled{background:#555;cursor:not-allowed;}
.auth-err{color:var(--red);font-size:.82rem;margin-top:.8rem;min-height:1.4em;}
.zero-overlay{position:fixed;inset:0;background:rgba(0,0,0,.97);z-index:3000;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .4s;}
.zero-overlay.open{opacity:1;pointer-events:all;}
.zero-box{text-align:center;padding:3rem 2rem;}
.zero-icon{font-size:5rem;margin-bottom:1rem;}
.zero-title{font-size:1.8rem;font-weight:900;margin-bottom:.5rem;}
.zero-sub{color:var(--muted);font-size:.95rem;margin-bottom:2rem;}
.loading{text-align:center;padding:4rem;display:none;}
.spinner{width:48px;height:48px;border:3px solid var(--border);border-top-color:var(--red);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 1rem;}
@keyframes spin{to{transform:rotate(360deg);}}
.empty-state{text-align:center;padding:5rem;display:none;}
.empty-state .icon{font-size:4rem;margin-bottom:1rem;}
.empty-state p{color:var(--muted);}
.load-more-wrap{text-align:center;margin-top:2rem;}
.load-more-btn{background:transparent;border:1px solid var(--red);color:var(--red);padding:.75rem 3rem;border-radius:8px;font-family:'Cairo',sans-serif;font-size:.95rem;cursor:pointer;transition:all .2s;}
.load-more-btn:hover{background:var(--red);color:#fff;}
@media(max-width:600px){header{padding:0 1rem;gap:.8rem;}.logo{font-size:1.4rem;}.user-name{display:none;}main{padding:1rem;}.video-grid{grid-template-columns:1fr;}}
</style>
</head>
<body>

<!-- AUTH -->
<div class="auth-overlay" id="authOverlay">
  <div class="auth-box">
    <div class="auth-logo">WIN<span>TUBE</span></div>
    <div class="auth-sub">Ø´Ø§Ù‡Ø¯ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª ÙˆØ§ÙƒØ³Ø¨ Ù†Ù‚Ø§Ø·Ùƒ!</div>
    <div class="bonus-badge">ğŸ Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ <strong>100 Ù†Ù‚Ø·Ø©</strong> Ù…Ø¬Ø§Ù†Ø§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</div>
    <div class="auth-tabs">
      <button class="auth-tab active" id="loginTab" onclick="switchTab('login')">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
      <button class="auth-tab" id="regTab" onclick="switchTab('reg')">Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
    </div>
    <div id="loginForm">
      <input class="auth-input" type="email" id="lEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" autocomplete="email">
      <input class="auth-input" type="password" id="lPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" autocomplete="current-password">
      <button class="auth-submit" id="loginBtn" onclick="doLogin()">Ø¯Ø®ÙˆÙ„ â†</button>
    </div>
    <div id="regForm" style="display:none">
      <input class="auth-input" type="text" id="rName" placeholder="Ø§Ù„Ø§Ø³Ù…" autocomplete="name">
      <input class="auth-input" type="email" id="rEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" autocomplete="email">
      <input class="auth-input" type="password" id="rPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (6 Ø£Ø­Ø±Ù+)" autocomplete="new-password">
      <button class="auth-submit" id="regBtn" onclick="doRegister()">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ â†</button>
    </div>
    <div class="auth-err" id="authErr"></div>
  </div>
</div>

<!-- ZERO POINTS -->
<div class="zero-overlay" id="zeroOverlay">
  <div class="zero-box">
    <div class="zero-icon">ğŸ’¸</div>
    <div class="zero-title">Ù†ÙØ¯Øª Ù†Ù‚Ø§Ø·Ùƒ!</div>
    <div class="zero-sub">Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ù…Ø²ÙŠØ¯. Ø§Ø´Ø­Ù† Ù†Ù‚Ø§Ø·Ùƒ Ù„Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø±.</div>
    <button class="auth-submit" style="max-width:220px;margin:0 auto;display:block"
      onclick="document.getElementById('zeroOverlay').classList.remove('open')">Ø­Ø³Ù†Ø§Ù‹</button>
  </div>
</div>

<!-- HEADER -->
<header>
  <div class="logo">WIN<span>TUBE</span></div>
  <div class="search-bar">
    <button onclick="doSearch()">ğŸ”</button>
    <input type="text" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£ÙŠ ÙÙŠØ¯ÙŠÙˆ..."
      onkeydown="if(event.key==='Enter')doSearch()">
  </div>
  <div class="user-panel" onclick="doSignOut()">
    <div>
      <div class="user-name" id="hName">â€”</div>
      <div class="user-pts">â­ <span id="hPts">0</span> Ù†Ù‚Ø·Ø©</div>
    </div>
    <div class="user-avatar" id="hAvatar">?</div>
  </div>
</header>

<!-- CATEGORIES -->
<div class="categories">
  <button class="cat-btn active" onclick="searchCategory('trending',this)">ğŸ”¥ Ø±Ø§Ø¦Ø¬</button>
  <button class="cat-btn" onclick="searchCategory('ØªØ¹Ù„ÙŠÙ…',this)">ğŸ“š ØªØ¹Ù„ÙŠÙ…</button>
  <button class="cat-btn" onclick="searchCategory('ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§',this)">ğŸ’» ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§</button>
  <button class="cat-btn" onclick="searchCategory('Ø±ÙŠØ§Ø¶Ø©',this)">âš½ Ø±ÙŠØ§Ø¶Ø©</button>
  <button class="cat-btn" onclick="searchCategory('Ù…ÙˆØ³ÙŠÙ‚Ù‰',this)">ğŸµ Ù…ÙˆØ³ÙŠÙ‚Ù‰</button>
  <button class="cat-btn" onclick="searchCategory('Ø·Ø¨Ø®',this)">ğŸ³ Ø·Ø¨Ø®</button>
  <button class="cat-btn" onclick="searchCategory('Ø³ÙØ±',this)">âœˆï¸ Ø³ÙØ±</button>
  <button class="cat-btn" onclick="searchCategory('Ø£Ù„Ø¹Ø§Ø¨',this)">ğŸ® Ø£Ù„Ø¹Ø§Ø¨</button>
  <button class="cat-btn" onclick="searchCategory('Ø£Ø®Ø¨Ø§Ø±',this)">ğŸ“° Ø£Ø®Ø¨Ø§Ø±</button>
</div>

<!-- MAIN -->
<main>
  <div class="section-title" id="sectionTitle">ğŸ”¥ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ø±Ø§Ø¦Ø¬Ø©</div>
  <div class="loading" id="loading"><div class="spinner"></div><p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>
  <div class="empty-state" id="emptyState"><div class="icon">ğŸ¬</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p></div>
  <div class="video-grid" id="videoGrid"></div>
  <div class="load-more-wrap" id="loadMoreWrap" style="display:none">
    <button class="load-more-btn" onclick="loadMore()">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯</button>
  </div>
</main>

<!-- VIDEO MODAL -->
<div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <div class="modal-header">
      <button class="close-btn" onclick="closeModal()">âœ•</button>
      <div class="modal-title" id="modalTitle"></div>
      <div class="points-counter">
        <div class="timer-ring">
          <svg width="38" height="38" viewBox="0 0 38 38">
            <circle class="ring-bg" cx="19" cy="19" r="16"/>
            <circle class="ring-fill" id="ringFill" cx="19" cy="19" r="16" stroke="#22c55e"/>
          </svg>
          <div class="timer-num" id="timerNum" style="color:#22c55e">30</div>
        </div>
        <div class="pts-info">
          <div class="pts-label">Ù†Ù‚Ø§Ø·Ùƒ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</div>
          <div class="pts-val" id="modalPts">0 Ù†Ù‚Ø·Ø©</div>
        </div>
      </div>
    </div>
    <div class="iframe-wrap">
      <iframe id="videoFrame" allowfullscreen allow="autoplay;encrypted-media"></iframe>
    </div>
    <div class="modal-desc" id="modalDesc"></div>
  </div>
</div>

<div class="toast" id="toast">-2 Ù†Ù‚Ø·Ø© âš¡</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STEP 1 â€” Load 3 Firebase compat scripts one after another
//           using a promise chain so each finishes before the next
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadScript(src) {
  return new Promise(function(resolve, reject) {
    var s = document.createElement('script');
    s.src = src;
    s.onload  = resolve;
    s.onerror = function() { reject(new Error('Failed to load: ' + src)); };
    document.head.appendChild(s);
  });
}

var FB_VER = '9.23.0';
loadScript('https://www.gstatic.com/firebasejs/' + FB_VER + '/firebase-app-compat.js')
  .then(function() {
    return loadScript('https://www.gstatic.com/firebasejs/' + FB_VER + '/firebase-auth-compat.js');
  })
  .then(function() {
    return loadScript('https://www.gstatic.com/firebasejs/' + FB_VER + '/firebase-firestore-compat.js');
  })
  .then(function() {
    // â”€â”€â”€ ALL 3 scripts loaded, safe to use firebase now â”€â”€â”€
    initApp();
  })
  .catch(function(err) {
    document.getElementById('authErr').textContent = 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Firebase: ' + err.message;
  });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STEP 2 â€” YouTube (no Firebase needed, runs immediately)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var YT_KEY        = 'AIzaSyDNK9EJ5IQ2dFLBn1jUk1hslgOwwTBdvJ0';
var nextPageToken = '';
var currentQuery  = 'trending';

function fmt(n){if(!n)return'';n=+n;return n>=1e6?(n/1e6).toFixed(1)+'M':n>=1e3?(n/1e3).toFixed(1)+'K':String(n);}
function parseDur(iso){if(!iso)return'';var m=iso.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);if(!m)return'';var h=+m[1]||0,mn=+m[2]||0,s=+m[3]||0;function p(x){return String(x).padStart(2,'0');}return h?h+':'+p(mn)+':'+p(s):mn+':'+p(s);}
function timeAgo(d){var sec=Math.floor((Date.now()-new Date(d))/1000);if(sec<60)return'Ø§Ù„Ø¢Ù†';if(sec<3600)return Math.floor(sec/60)+'Ø¯';if(sec<86400)return Math.floor(sec/3600)+'Ø³';if(sec<2592000)return Math.floor(sec/86400)+'ÙŠ';if(sec<31536000)return Math.floor(sec/2592000)+'Ø´';return Math.floor(sec/31536000)+'Ø³Ù†Ø©';}

function fetchVideos(query, pageToken, append) {
  pageToken=pageToken||''; append=append||false;
  document.getElementById('loading').style.display='block';
  document.getElementById('emptyState').style.display='none';
  var grid=document.getElementById('videoGrid');
  if(!append) grid.innerHTML='';
  var base='https://www.googleapis.com/youtube/v3/';

  function done(items,token){
    nextPageToken=token||'';
    document.getElementById('loading').style.display='none';
    if(items&&items.length){renderCards(items);}
    else if(!append){document.getElementById('emptyState').style.display='block';}
    document.getElementById('loadMoreWrap').style.display=nextPageToken?'block':'none';
  }
  function fail(e){
    document.getElementById('loading').style.display='none';
    if(!append) grid.innerHTML='<div style="color:#ff6b6b;padding:2rem;grid-column:1/-1;text-align:center">âš ï¸ '+e.message+'</div>';
  }

  if(query==='trending'){
    fetch(base+'videos?part=snippet,contentDetails,statistics&chart=mostPopular&regionCode=SA&hl=ar&maxResults=16&pageToken='+pageToken+'&key='+YT_KEY)
      .then(function(r){return r.json();}).then(function(d){if(d.error)throw new Error(d.error.message);done(d.items,d.nextPageToken);}).catch(fail);
  } else {
    fetch(base+'search?part=snippet&q='+encodeURIComponent(query)+'&type=video&maxResults=16&pageToken='+pageToken+'&key='+YT_KEY)
      .then(function(r){return r.json();}). then(function(sd){
        if(sd.error)throw new Error(sd.error.message);
        var ids=(sd.items||[]).map(function(i){return i.id.videoId;}).filter(Boolean);
        if(!ids.length){done([],sd.nextPageToken);return;}
        fetch(base+'videos?part=snippet,contentDetails,statistics&id='+ids.join(',')+'&key='+YT_KEY)
          .then(function(r){return r.json();}).then(function(vd){done(vd.items,sd.nextPageToken);}).catch(fail);
      }).catch(fail);
  }
}

function renderCards(items){
  var grid=document.getElementById('videoGrid');
  items.forEach(function(item){
    var s=item.snippet;
    var th=s.thumbnails&&(s.thumbnails.high||s.thumbnails.medium)?(s.thumbnails.high||s.thumbnails.medium).url:'';
    var d=parseDur(item.contentDetails&&item.contentDetails.duration);
    var vid=typeof item.id==='string'?item.id:(item.id&&item.id.videoId)||'';
    var views=item.statistics&&item.statistics.viewCount?fmt(item.statistics.viewCount)+' Ù…Ø´ â€¢ ':'';
    var card=document.createElement('div');
    card.className='video-card';
    card.innerHTML='<div class="thumb-wrap"><img src="'+th+'" alt="" loading="lazy"><div class="play-overlay"><div class="play-btn"><svg width="22" height="22" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></div></div>'+(d?'<div class="duration">'+d+'</div>':'')+'</div><div class="card-info"><div class="card-title">'+s.title+'</div><div class="card-meta"><span class="channel-name">'+s.channelTitle+'</span><span>'+views+timeAgo(s.publishedAt)+' Ù…</span></div></div>';
    (function(id,t,desc){card.onclick=function(){openModal(id,t,desc);};})(vid,s.title,s.description||'');
    grid.appendChild(card);
  });
}

function doSearch(){var q=document.getElementById('searchInput').value.trim();if(!q)return;currentQuery=q;nextPageToken='';document.getElementById('sectionTitle').textContent='Ù†ØªØ§Ø¦Ø¬: "'+q+'"';document.querySelectorAll('.cat-btn').forEach(function(b){b.classList.remove('active');});fetchVideos(q);}
function searchCategory(q,btn){currentQuery=q;nextPageToken='';document.getElementById('searchInput').value='';document.querySelectorAll('.cat-btn').forEach(function(b){b.classList.remove('active');});btn.classList.add('active');var L={trending:'ğŸ”¥ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ø±Ø§Ø¦Ø¬Ø©',ØªØ¹Ù„ÙŠÙ…:'ğŸ“š ØªØ¹Ù„ÙŠÙ…',ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§:'ğŸ’» ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§',Ø±ÙŠØ§Ø¶Ø©:'âš½ Ø±ÙŠØ§Ø¶Ø©',Ù…ÙˆØ³ÙŠÙ‚Ù‰:'ğŸµ Ù…ÙˆØ³ÙŠÙ‚Ù‰',Ø·Ø¨Ø®:'ğŸ³ Ø·Ø¨Ø®',Ø³ÙØ±:'âœˆï¸ Ø³ÙØ±',Ø£Ù„Ø¹Ø§Ø¨:'ğŸ® Ø£Ù„Ø¹Ø§Ø¨',Ø£Ø®Ø¨Ø§Ø±:'ğŸ“° Ø£Ø®Ø¨Ø§Ø±'};document.getElementById('sectionTitle').textContent=L[q]||q;fetchVideos(q);}
function loadMore(){if(nextPageToken)fetchVideos(currentQuery,nextPageToken,true);}

// Timer ring (safe to call before Firebase)
var CIRCUMFERENCE=101, timerSecs=30, watchTimer=null;
function drawRing(){
  var fill=document.getElementById('ringFill'),num=document.getElementById('timerNum');
  if(!fill||!num)return;
  var frac=timerSecs/30,color=frac>.6?'#22c55e':frac>.3?'#f59e0b':'#ff2d2d';
  fill.style.strokeDashoffset=CIRCUMFERENCE*(1-frac);
  fill.style.stroke=color; num.style.color=color; num.textContent=timerSecs;
}

// Placeholder for openModal â€” real one assigned in initApp
function openModal(vid,title,desc){
  document.getElementById('authOverlay').classList.remove('hidden');
}
function closeModal(){
  clearInterval(watchTimer); watchTimer=null; timerSecs=30; drawRing();
  document.getElementById('modalOverlay').classList.remove('open');
  document.getElementById('videoFrame').src='';
}
function switchTab(tab){
  document.getElementById('loginForm').style.display=tab==='login'?'':'none';
  document.getElementById('regForm').style.display=tab==='reg'?'':'none';
  document.getElementById('loginTab').classList.toggle('active',tab==='login');
  document.getElementById('regTab').classList.toggle('active',tab==='reg');
  document.getElementById('authErr').textContent='';
}

// These are safe no-ops until Firebase loads
function doLogin(){document.getElementById('authErr').textContent='Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Firebase...';}
function doRegister(){document.getElementById('authErr').textContent='Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Firebase...';}
function doSignOut(){}

// Start YouTube immediately (doesn't need Firebase)
drawRing();
fetchVideos('trending');


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STEP 3 â€” initApp() called only after all 3 Firebase
//            scripts finish loading (from the promise chain above)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initApp() {
  // Firebase is now 100% ready
  firebase.initializeApp({
    apiKey:            'AIzaSyCOV-2qbB6eFEU-myiTjlXbcE-bWhuqLQs',
    authDomain:        'wintube-8bcaa.firebaseapp.com',
    projectId:         'wintube-8bcaa',
    storageBucket:     'wintube-8bcaa.firebasestorage.app',
    messagingSenderId: '459173658209',
    appId:             '1:459173658209:web:d1e5ddf04ecf548cc67420'
  });

  var auth = firebase.auth();
  var db   = firebase.firestore();

  var DEDUCT_EVERY = 30, DEDUCT_AMT = 2, START_PTS = 100;
  var currentUser = null, userPoints = 0;

  // â”€â”€ Firestore â”€â”€
  function loadPoints(uid, cb){
    db.collection('users').doc(uid).get().then(function(snap){
      if(snap.exists){
        userPoints=snap.data().points!==undefined?snap.data().points:0; cb();
      } else {
        db.collection('users').doc(uid).set({
          name:currentUser.displayName||'Ù…Ø³ØªØ®Ø¯Ù…',email:currentUser.email,
          points:START_PTS,createdAt:firebase.firestore.FieldValue.serverTimestamp()
        }).then(function(){userPoints=START_PTS;cb();});
      }
    }).catch(function(e){console.error(e);userPoints=0;cb();});
  }
  function savePoints(){
    if(!currentUser)return;
    db.collection('users').doc(currentUser.uid).update({points:userPoints}).catch(console.error);
  }

  // â”€â”€ Auth observer â”€â”€
  auth.onAuthStateChanged(function(user){
    if(user){
      currentUser=user;
      loadPoints(user.uid,function(){
        updateHeader();
        document.getElementById('authOverlay').classList.add('hidden');
      });
    } else {
      currentUser=null; userPoints=0; stopTimer();
      document.getElementById('authOverlay').classList.remove('hidden');
    }
  });

  // â”€â”€ Header â”€â”€
  function updateHeader(){
    document.getElementById('hPts').textContent=userPoints;
    var name=currentUser.displayName||currentUser.email.split('@')[0];
    document.getElementById('hName').textContent=name;
    document.getElementById('hAvatar').textContent=name[0].toUpperCase();
  }

  // â”€â”€ Timer â”€â”€
  function startTimer(){
    stopTimer(); timerSecs=DEDUCT_EVERY; drawRing();
    watchTimer=setInterval(function(){
      timerSecs--; drawRing();
      if(timerSecs<=0){
        timerSecs=DEDUCT_EVERY;
        userPoints=Math.max(0,userPoints-DEDUCT_AMT);
        savePoints(); updateHeader();
        document.getElementById('modalPts').textContent=userPoints+' Ù†Ù‚Ø·Ø©';
        showToast();
        var pv=document.getElementById('modalPts');
        pv.classList.remove('flash'); void pv.offsetWidth; pv.classList.add('flash');
        setTimeout(function(){pv.classList.remove('flash');},600);
        if(userPoints<=0){stopTimer();closeModal();document.getElementById('zeroOverlay').classList.add('open');}
      }
    },1000);
  }
  function stopTimer(){clearInterval(watchTimer);watchTimer=null;timerSecs=DEDUCT_EVERY;drawRing();}
  function showToast(){var t=document.getElementById('toast');t.classList.add('show');setTimeout(function(){t.classList.remove('show');},1800);}

  function errMsg(code){
    var m={'auth/user-not-found':'Ø§Ù„Ø¨Ø±ÙŠØ¯ ØºÙŠØ± Ù…Ø³Ø¬Ù‘Ù„','auth/wrong-password':'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©',
      'auth/invalid-credential':'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©','auth/email-already-in-use':'Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ø§Ù‹',
      'auth/invalid-email':'Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­','auth/weak-password':'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ø§Ù‹',
      'auth/network-request-failed':'ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª','auth/too-many-requests':'Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙƒØ«ÙŠØ±Ø©ØŒ Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹'};
    return m[code]||('Ø®Ø·Ø£: '+code);
  }
  function showErr(msg){document.getElementById('authErr').textContent=msg;}
  function setBtn(id,dis,label){var b=document.getElementById(id);b.disabled=dis;b.textContent=label;}

  // â”€â”€ Override the placeholder functions with real Firebase ones â”€â”€
  doLogin = function(){
    var email=document.getElementById('lEmail').value.trim();
    var pass=document.getElementById('lPass').value;
    if(!email||!pass){showErr('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„');return;}
    showErr(''); setBtn('loginBtn',true,'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„...');
    auth.signInWithEmailAndPassword(email,pass)
      .catch(function(e){showErr(errMsg(e.code));setBtn('loginBtn',false,'Ø¯Ø®ÙˆÙ„ â†');});
  };

  doRegister = function(){
    var name=document.getElementById('rName').value.trim();
    var email=document.getElementById('rEmail').value.trim();
    var pass=document.getElementById('rPass').value;
    if(!name||!email||!pass){showErr('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„');return;}
    if(pass.length<6){showErr('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');return;}
    showErr(''); setBtn('regBtn',true,'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡...');
    auth.createUserWithEmailAndPassword(email,pass)
      .then(function(cred){return cred.user.updateProfile({displayName:name});})
      .catch(function(e){showErr(errMsg(e.code));setBtn('regBtn',false,'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ â†');});
  };

  doSignOut = function(){
    if(!confirm('ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ'))return;
    stopTimer(); closeModal(); auth.signOut();
  };

  openModal = function(vid,title,desc){
    if(!currentUser){document.getElementById('authOverlay').classList.remove('hidden');return;}
    if(userPoints<=0){document.getElementById('zeroOverlay').classList.add('open');return;}
    document.getElementById('videoFrame').src='https://www.youtube.com/embed/'+vid+'?autoplay=1';
    document.getElementById('modalTitle').textContent=title;
    document.getElementById('modalDesc').textContent=desc;
    document.getElementById('modalPts').textContent=userPoints+' Ù†Ù‚Ø·Ø©';
    document.getElementById('modalOverlay').classList.add('open');
    startTimer();
  };

  closeModal = function(){
    stopTimer();
    document.getElementById('modalOverlay').classList.remove('open');
    document.getElementById('videoFrame').src='';
  };
}
</script>
</body>
</html>
